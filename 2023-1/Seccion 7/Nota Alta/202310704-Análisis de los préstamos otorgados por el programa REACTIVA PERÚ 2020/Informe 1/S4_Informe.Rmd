---
title: "Análisis de los préstamos otorgados por el programa REACTIVA PERÚ 2020"
output:
  html_document:
    df_print: paged
---
## Relevancia

La importancia de este tema radica en que el programa REACTIVA PERÚ es una de las medidas económicas más importantes implementadas por el gobierno peruano para mitigar el impacto de la crisis sanitaria en la economía nacional. Por lo tanto, es fundamental evaluar la efectividad de este programa para comprender su impacto en la recuperación y reactivación de la economía peruana.

### Objetivos Específicos

1.  Identificar y analizar la distribución geográfica de los préstamos otorgados por el programa REACTIVA PERÚ, a nivel departamental y sectorial, en el periodo comprendido entre el 1 de abril de 2020 y el 31 de diciembre de 2020, utilizando medidas descriptivas y gráficos apropiados, para comprender la magnitud de la intervención en cada zona y sector de la economía.

2.  Identificar las entidades financieras que otorgaron los préstamos y su distribución geográfica, analizando si existen vínculos sospechosos o conflictos de interés, con el fin de determinar si existe algún tipo de favoritismo o trato preferencial en la asignación de los préstamos.

3.  Realizar un análisis comparativo entre las empresas que lograron pagar el préstamo y las que aún mantienen deudas, a nivel departamental y sectorial, para identificar a las empresas que hacen una mala gestión de los préstamos en relación a las deudas que mantienen.

4.  Evaluar el impacto de los préstamos en la recuperación y reactivación de la economía peruana, a nivel departamental, analizando variables económicas relevantes como el PBI, la tasa de empleo y la tasa de desempleo, para comprender el alcance y la efectividad de los préstamos en el contexto de la crisis sanitaria.

5.  Identificar posibles sesgos en la muestra seleccionada, evaluando la validez y confiabilidad de los resultados obtenidos mediante análisis estadístico, con el fin de garantizar la robustez del análisis y asegurar la calidad de los hallazgos a nivel departamental y sectorial.

## Planificación
- Previamente debemos importar las librerías necesarias para el desarrollo del proyecto
```{r}
library(dplyr)
library(DT)
library(funModeling)
library(ggplot2)
library(ggalt)
library(plotly)
library(lubridate)
library(readr)
library(tidyverse)
```


```{r}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

df <- data.frame(Stage = c("Tema y objetivos", "Instrumento de recoleccion", "Base de datos", " Variables", " Descriptores", " Analisis de descriptores"),
                 Start = c("2023-04-10", "2023-04-19", "2023-04-22", "2023-05-01", "2023-05-06", "2023-05-24"),
                 End = c("2023-04-19", "2023-04-22", "2023-05-01", "2023-05-06", "2023-05-24", "2023-05-27"),
                 Complete = c(TRUE, FALSE, TRUE, FALSE, FALSE, FALSE))


df$Start <- ymd(df$Start)
df$End <- ymd(df$End)

df.melt <- df %>% tidyr::pivot_longer(cols = c(Start, End))

today <- as.Date('2022-04-22')

pl <- ggplot(df.melt, aes(x = value, y = Stage, colour = Complete ))
pl <- pl + geom_line( alpha = 0.2, size = 10)
pl <- pl + geom_text(aes(label = format(value, "%d %b")), vjust = -0.5, angle = 45, size = 3, color = "black")
pl <- pl +   theme_classic()
pl <- pl + geom_vline(xintercept = today, color = "red", size = 2, alpha = 0.5)
pl <- pl + labs(title = "Diagrama de Gantt")
pl <- pl + labs(x = "Fechas")
pl <- pl + labs(y = "Tareas")
pl <- pl + scale_color_manual(values = c("red", "blue"))
pl <- pl + theme(legend.position = "none")
pl <- pl + theme(panel.background = element_rect(color = "black"))
pl <- pl + scale_x_date(name = "Fechas",
                        date_labels = "%d %b",
                        date_breaks = "5 days",
                        minor_breaks = "1 day",
                        )
pl
```

### Registro de Actividades
```{r}
columna1 <- c("Tema y objetivos", "Instrumento de recoleccion", "Base de datos", "Variables", "Descriptores", "Analisis de descriptores")

columna2 <- as.Date(c("2023-04-10", "2023-04-19", "2023-04-22", "2023-05-01", "2023-05-06", "2023-05-24"))

columna3 <- as.Date(c("2023-04-19", "2023-04-22", "2023-05-01", "2023-05-06", "2023-05-24", "2023-05-27"))

columna4 <- c("9", "3", "9", "5", "18", "3")

df <- data.frame(Actividades = columna1, Inicio = columna2, Fin = columna3, Duracion = columna4)

tabla_html <- datatable(df, options = list(dom = 't', paging = FALSE), rownames = FALSE) %>%
  formatStyle(names(df), `text-align` = "format") %>%
  formatStyle(1, backgroundColor = "lightgray") %>%
  formatStyle(2, backgroundColor = "#f2f2f2")

tabla_html
```

# Datos

## Proceso de recoleccion de datos
### - Prueba de donde se sacaron los datos

# NO CORRER! Saltese a la linea 243

El objetivo principal de nuestro estudio era enriquecer la base de datos de REACTIVA PERÚ a través de un enfoque multi-etapa. Este enfoque constó de dos etapas principales: la primera involucraba la descarga y selección de nuestra muestra de estudio, y la segunda etapa se centraba en la adquisición de datos adicionales mediante web scraping.

La primera etapa del enfoque multi-etapa comenzó con la descarga de la base de datos de REACTIVA PERÚ. Este conjunto de datos contenía información sobre más de 70.000 empresas que habían recibido apoyo financiero a través de REACTIVA PERÚ. Aunque la base de datos ofrecía información básica, como el nombre de la empresa, el Registro Único de Contribuyentes (RUC), el sector al que pertenecen, el monto del préstamo otorgado, el monto de cobertura y el departamento, nuestro objetivo era extraer información adicional para obtener una comprensión más completa de las empresas y sus operaciones.

```{r}
# Leer el archivo csv
data <- read_csv("REACTIVA2020.csv")

# Extraer la columna RUC
ruc <- data$RUC 

# Guardar la columna RUC en un archivo txt, una línea por RUC
writeLines(ruc, "ruc.txt")
```

Una vez que la base de datos fue descargada, procedimos a seleccionar nuestra población y muestra de estudio. La población de nuestro estudio consistía en todas las empresas que habían recibido préstamos a través de REACTIVA PERÚ, mientras que la muestra fue seleccionada siguiendo un enfoque estratificado. Ordenamos las empresas por departamento, de mayor a menor, en términos del monto de préstamo otorgado. Luego, aplicamos una estratificación utilizando percentiles (100 tiles) para garantizar una menor inclinación en la representación de la muestra. Optamos por este enfoque en lugar de usar cuartiles o quintiles debido a la considerable variabilidad en los montos de préstamo otorgados, que oscilaban entre 2,000 y 1,000,000 soles.

Después de seleccionar la muestra, la segunda etapa del enfoque multi-etapa involucró el uso de web scraping como nuestra técnica principal de adquisición de datos. El web scraping es un método automatizado de extracción de información de sitios web, que simula la interacción de un usuario con una página web y captura los datos presentes en ella. Para llevar a cabo este proceso, optamos por utilizar Python como nuestro lenguaje de programación debido a su robustez y a las numerosas bibliotecas disponibles para web scraping, en particular Selenium.

Selenium es una biblioteca en Python que proporciona una interfaz de alto nivel para controlar y automatizar las interacciones con el navegador web. Este marco de trabajo se eligió por su capacidad para manipular eficazmente las páginas web dinámicas que cargan su contenido mediante JavaScript, como es el caso de la página web de la Superintendencia Nacional de Aduanas y de Administración Tributaria (SUNAT) de Perú.

Para recopilar los datos, comenzamos por obtener los números de Registro Único de Contribuyentes (RUC) de las empresas a partir de la base de datos pública del programa REACTIVA PERÚ. Estos números de RUC fueron almacenados en un archivo de texto llamado 'ruc.txt', con cada número de RUC en una línea separada. Este archivo nos proporcionó una lista de las empresas a las que se habían otorgado préstamos, y los números de RUC se utilizaron para buscar información adicional sobre estas empresas en la página web de SUNAT.

Para ejecutar el script de web scraping, fue necesario instalar el controlador de Google Chrome para Selenium en una máquina con sistema operativo Ubuntu. Este controlador permite a Selenium interactuar con el navegador Google Chrome instalado en la máquina. El controlador de Chrome para Selenium puede descargarse del sitio oficial de Chromium en <https://chromedriver.chromium.org/downloads>.

El proceso de extracción de datos se llevó a cabo en varios pasos. Primero, para cada número de RUC, se iniciaba un navegador web Chrome utilizando Selenium. Luego, se dirigía al navegador a la página de consulta de RUC de SUNAT. Allí, se ingresaba el número de RUC en el campo de búsqueda, y se hacía clic en el botón de búsqueda para solicitar los detalles de la empresa correspondiente. Una vez que los detalles de la empresa se cargaban en la página, se utilizaban los métodos proporcionados por Selenium para localizar y capturar la información requerida de los elementos de la página web.

Los datos que buscábamos incluían el nombre o razón social de la empresa, el tipo de empresa, el estado de la empresa y la fecha de inicio de las actividades. En el caso de que no se pudiera encontrar alguno de estos datos, se llenaban los campos correspondientes con el valor 'No encontrado', y se marcaba la condición de la empresa como 'DESACTIVADA'. Este manejo de excepciones garantiza que el proceso de extracción de datos pueda continuar incluso cuando se encuentren problemas en la búsqueda de datos.

Los datos extraídos se almacenaron en un archivo CSV, que es un formato ampliamente aceptado para el almacenamiento de datos tabulares. Si el archivo CSV, titulado 'rucs.csv', no existía en el momento de la extracción de los datos, se creaba un nuevo archivo y se escribían las cabeceras de las columnas y los datos recién extraídos. Si el archivo ya existía, simplemente se añadían los nuevos datos al final del archivo. Esta operación se repetía para cada número de RUC en el archivo 'ruc.txt', lo que resultó en una colección comprensiva de datos sobre las empresas peruanas.

El código usado es el siguiente:

```{python}
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
import time
import logging
from selenium.webdriver.remote.remote_connection import LOGGER
from pathlib import Path
import csv

# Configuración del registro de errores de Selenium
LOGGER.setLevel(logging.ERROR)

# Abrir el archivo ruc.txt y contar las líneas
with open('ruc.txt') as f:
    lines = f.read().splitlines()
    num_lines = len(lines)

# Iterar sobre cada línea del archivo ruc.txt
for line in range(num_lines):
    ruc = lines[line]
    print(ruc)

    # Inicializar el servicio del driver de Chrome
    service = Service(str(Path('~/Downloads/chromedriver').expanduser().resolve()))

    # Inicializar el driver de Chrome
    driver = webdriver.Chrome(service=service)

    # Abrir el sitio web objetivo
    driver.get(f"https://e-consultaruc.sunat.gob.pe/cl-ti-itmrconsruc/jcrS00Alias")

    # Ingresar el número de RUC en el campo correspondiente
    input_ruc = driver.find_element(By.ID, 'txtRuc')
    input_ruc.send_keys(f"{ruc}")

    # Hacer clic en el botón de búsqueda
    search_button = driver.find_element(By.XPATH, '//input[@type="submit" and @value="Consultar"]')
    search_button.click()

    # Esperar 5 segundos para que la página se cargue
    time.sleep(5)

    try:
        # Obtener la información requerida utilizando los métodos de Selenium
        data = {}
        data['Número de RUC'] = ruc
        data['Razón Social'] = driver.find_element(By.XPATH, '//td[contains(text(), "Nombre o Razón Social:")]/following-sibling::td').text
        data['Tipo Empresa'] = driver.find_element(By.XPATH, '//td[contains(text(), "Tipo Contribuyente:")]/following-sibling::td').text
        data['Condición'] = driver.find_element(By.XPATH, '//td[contains(text(), "Estado:")]/following-sibling::td').text
        data['Fecha Inicio Actividades'] = driver.find_element(By.XPATH, '//td[contains(text(), "Fecha de Inscripción:")]/following-sibling::td').text
    except:
        # Manejo de excepciones en caso de que no se encuentren los datos requeridos
        data = {}
        data['Número de RUC'] = ruc
        data['Razón Social'] = 'No encontrado'
        data['Tipo Empresa'] = 'No encontrado'
        data['Condición'] = 'DESACTIVADA'
        data['Fecha Inicio Actividades'] = 'No encontrado'

    # Si el archivo csv no existe, se crea y se escribe la cabecera de las columnas
    if not Path('rucs.csv').exists():
        with open('rucs.csv', 'w', newline='') as file:
            writer = csv.writer(file, delimiter=';')
            writer.writerow(data.keys())
            writer.writerow(data.values())
    else:
        # Si el archivo csv existe, se agregan los datos a las columnas con ';' como separador
        with open('rucs.csv', 'a', newline='') as file:
            writer = csv.writer(file, delimiter=';')
            writer.writerow(data.values())

    # Cerrar el navegador
    driver.quit()
```

Para ejecutar el código, es necesario asegurarse de tener instaladas las bibliotecas necesarias en su entorno Python. Las bibliotecas requeridas son:

1.  Selenium: Es un framework para pruebas de aplicaciones web que proporciona una forma de escribir scripts en Python para automatizar el navegador.

2.  pathlib: Es una biblioteca para manipular rutas de archivos y directorios de manera orientada a objetos.

3.  csv: Esta biblioteca es esencial para leer y escribir archivos CSV.

Estas bibliotecas se pueden instalar usando pip, el sistema de gestión de paquetes de Python. El comando para instalar estas bibliotecas es:

```{bash}
pip install selenium pathlib
```

Además, se necesita el WebDriver de Chrome para Selenium. Se puede descargar del [**sitio web oficial de ChromeDriver**](https://chromedriver.chromium.org/downloads). Después de descargarlo, se debe modificar la ruta del WebDriver en la línea 18 del código, para reflejar la ubicación donde se almacenó el archivo ejecutable del WebDriver.

Finalmente, es necesario crear un archivo de texto llamado 'ruc.txt' en el mismo directorio donde se encuentra el script de Python. Este archivo debe contener los números RUC de las empresas que se desean investigar, uno por línea.

Para ejecutar el script, se puede usar la terminal (en el caso de Ubuntu o cualquier otro sistema basado en Linux). El comando para ejecutar el script es:

```{bash}
python3 webscraping.py
```

Una ventaja crucial de usar Python para realizar el web scraping es que los datos extraídos se obtienen en formato CSV, eliminando la necesidad de procesamiento adicional. El script genera un archivo llamado 'rucs.csv' que almacena la información adicional de las empresas. Este archivo se encuentra en el mismo directorio donde se ejecutó el script.

Es importante mencionar que el archivo 'rucs.csv' se guarda en formato UTF-8 para evitar errores relacionados con caracteres especiales como tildes. Python maneja automáticamente la codificación y decodificación de caracteres durante la lectura y escritura de archivos, lo que facilita el manejo de datos y la prevención de errores comunes.

## ¿Cómo se procesaron los datos?

Primero cargamos los datos de la base de datos pública del programa REACTIVA PERÚ. Luego, re-nombramos las columnas para que tengan nombres más cortos y fáciles de usar.

```{r}
data <- read_csv("data_modificado.csv",col_types = "cccccnnccccnc")
data
```

```{r}
data %>% rename(NomEmp = `NOMBRE EMPRESA`
              , Ruc = RUC
              , Sect = SECTOR
              , TipEnt = `TIPO DE ENTIDAD OTORGANTE DEL BCP`
              , NomEnt = `NOMBRE ENTIDAD OTORGANTE DEL BCP`
              , MonPre = `MONTO PRESTAMO`
              , MonCo = `MONTO COBERTURA`
              , Depa = DEPARTAMENTO
              , TipEmp = `Tipo Empresa`
              , Cond = Condición
              , FechInAct = `Fecha Inicio Actividades`
              , AniAct = `Años Actividad`
              , CatAmb = categoria_antiguedad
              ) -> data
```


## ¿Cómo analizamos los datos?

### Cálculos de las tasas de empleo

La Tasa de Empleo se refiere a la proporción de la Población Económicamente Activa (PEA) que está trabajando. La PEA se define como la suma de las personas que tienen un empleo (ocupadas) y las que buscan un empleo (desempleadas). Para calcular la tasa de empleo de cada año, utilizaremos la siguiente fórmula:

`Tasa de Empleo = (Población Económicamente Activa Ocupada / Población Económicamente Activa) * 100`

La Población Económicamente Activa Ocupada representa a las personas que tienen un empleo durante el periodo de tiempo evaluado, mientras que la Población Económicamente Activa incluye tanto a las personas que están empleadas como a las que buscan activamente un empleo.

Por lo tanto, la tasa de empleo es la proporción de la Población Económicamente Activa que está empleada. Esta medida nos proporciona información sobre la eficacia de la economía de una región para proporcionar empleo a las personas que están disponibles y dispuestas a trabajar.

Mientras que para calcular la tasa de desempleo por año, usaremos la siguiente fórmula:

`Tasa de Desempleo = ((POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO - POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA) / POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE) *100`

```{r}
# Carga los datos
DI <- read_csv("data_INEI.csv")

# Limpia y convierte las columnas a numérico
DI <- DI %>%
  mutate(
    `POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2018 (Miles de personas)` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2018 (Miles de personas)`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2019 (Miles de personas)` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2019 (Miles de personas)`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2020 (Miles de personas)` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2020 (Miles de personas)`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2021 (Miles de personas)` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2021 (Miles de personas)`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2018` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2018`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2019` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2019`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2020` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2020`))),
    `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2021` = as.numeric(gsub(",", "", trimws(`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2021`)))
  )

# Calcula la tasa de empleo
DI <- DI %>%
  mutate(
    `Tasa de Empleo 2018` = (`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2018 (Miles de personas)` / `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2018`) * 100,
    `Tasa de Empleo 2019` = (`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2019 (Miles de personas)` / `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2019`) * 100,
    `Tasa de Empleo 2020` = (`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2020 (Miles de personas)` / `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2020`) * 100,
    `Tasa de Empleo 2021` = (`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2021 (Miles de personas)` / `POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2021`) * 100,
    `Tasa de Desempleo 2018` = ((`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2018`-`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2018 (Miles de personas)`)/`POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2018`) *100,
    `Tasa de Desempleo 2019` = ((`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2019`-`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2019 (Miles de personas)`)/`POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2019`) *100,
    `Tasa de Desempleo 2020` = ((`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2020`-`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2020 (Miles de personas)`)/`POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2020`) *100,
    `Tasa de Desempleo 2021` = ((`POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2021`-`POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2021 (Miles de personas)`)/`POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2021`) *100
  )

# Escribe el DataFrame modificado en un nuevo archivo CSV
write_csv(DI, "data_INEI_con_tasas.csv")
```
```{r}
DI
```
#Variables
```{r}
#Del archivo data_modificado
variables <- data.frame(
  Variable = c("NomEmp", "Ruc", "Sect", "TipEnt", "NomEnt", "MonPre", "MonCo","Depa" ,"Cond", "FechInAct", "AniAct", "CatAmb"),
  Tipo = c("Categórica Nominal", "Categórica Nominal", "Categórica Nominal", "Categórica Ordinal", "Categórica Nominal", "Numérica Continua", "Numérica Continua","Categórica Nominal", "Categórica Ordinal", "Numerica Continua", "Numérica Discreta", "Categórica Ordinal"),
  Restricciones = c("Nombres de las empresas",
                    "RUC de las empresas",
                    "Sector al que pertenecen las empresas",
                    "Tipo de entidad que otorgó el préstamo",
                    "Nombre de la entidad que otorgó el préstamo",
                    "Número real positivo",
                    "Número real positivo",
                    "Departamentos",
                    "Empresas activas",
                    "Fecha de inicio de actividades de la empresa",
                    "Entero positivo mayor a 0",
                    "dividido en tier1, tier2, tier3")
)
variables
```
```{r}
variables2 <- data.frame(
  Variable = c("Depatamento",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2018 (Miles de personas)",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2019 (Miles de personas)",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2020 (Miles de personas)",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA OCUPADA 2021 (Miles de personas)",
               "POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2018",
               "POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2019",
               "POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2020",
               "POBLACIÓN EN EDAD DE TRABAJAR PORCENTAJE 2021",
               "POBLACIÓN POR DEPARTAMENTO CENSO 2017",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2018",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2019",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2020",
               "POBLACIÓN ECONÓMICAMENTE ACTIVA  POR DEPARTAMENTO 2021",
               "Tasa de Empleo 2018",
               "Tasa de Empleo 2019",
               "Tasa de Empleo 2020",
               "Tasa de Empleo 2021",
               "Tasa de Desempleo 2018",
               "Tasa de Desempleo 2019",
               "Tasa de Desempleo 2020",
               "Tasa de Desempleo 2021"),
  Clasificación = c("Categórica Nominal",
                    "Numérica Continua (Miles de personas)",
                    "Numérica Continua (Miles de personas)",
                    "Numérica Continua (Miles de personas)",
                    "Numérica Continua (Miles de personas)",
                    "Numérica Continua (Porcentaje)",
                    "Numérica Continua (Porcentaje)",
                    "Numérica Continua (Porcentaje)",
                    "Numérica Continua (Porcentaje)",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua",
                    "Numérica Continua"
  ),
  Restricción = c("Departamentos del Perú",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo",
                  "Real Positivo"
  )
)
variables2
```

# Limpieza de datos de la data INEI con tasas

```{r}
datos <- select(DI, -c(...15, ...16, ...17, ...18, ...19, ...20, ...21, ...22, ...23, ...24, ...25, ...26))
datos
```
```{r}
datosT <- datos[complete.cases(datos),]
datosT
```

# Analisis Descriptivo

Para comenzar analizaremos los montos prestados en total por departamento y sector: 
```{r}
descriptivas_departamento <- data %>%
  group_by(Depa) %>%
  summarise(Total_Prestamos = sum(MonPre)) %>%
  arrange(desc(Total_Prestamos))


descriptivas_sector <- data %>%
  group_by(Sect) %>%
  summarise(Total_Prestamos = sum(MonPre)) %>%
  arrange(desc(Total_Prestamos))

descriptivas_departamento
descriptivas_sector
```

Ahora procedemos con sacar las medidas descriptivas de los departamentos:  
```{r}
round(median(descriptivas_departamento$Total_Prestamos),2)
round(mean(descriptivas_departamento$Total_Prestamos),2)
round((sd(descriptivas_departamento$Total_Prestamos)/mean(descriptivas_departamento$Total_Prestamos))*100,2)
```
Donde se puede concluir en las medidas descriptivas de los departamentos: 
- El promedio del monto prestado de los solicitados por los años 2018 al 2021 por departamento fue de S/21182493 ademas, mediante la tabla se observa que el préstamo menor es S/7555711 perteneciente a Huancavelica y  el Callao es el departamento que mayor monto ha cobrado en total con S/42798250.
- El coeficiente de variación del Total de prestamos en los Departamentos es de 42.26%, cuyo valor señala que el grado de dispersión con respecto la media es moderada, lo que indica una distribución relativamente homogénea alrededor de este valor central.

Descriptivas de los sectores
```{r}
summary(descriptivas_sector$Total_Prestamos)
round((sd(descriptivas_sector$Total_Prestamos)/mean(descriptivas_sector$Total_Prestamos))*100,2)
```

- Podemos observar que en los sectores que el promedio general en prestamos totales es de S/37825880 y el monto prestado mínimo es S/186968 pertenecientes al sector Intermediación Finaciera y el máximo es de S/241417020, perteneciente al Comercio.
- El coeficiente de variación es de 168.22% en el total de prestamos de los sectores, eso significa que la dispersión de los datos es alta en comparación con la media, lo que implica una variabilidad considerable en los datos.


```{r}
# Gráfico de barras por departamento
grafico_departamento <- ggplot(descriptivas_departamento, aes(x = Depa, y = Total_Prestamos)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Departamento", y = "Total de Préstamos") +
  ggtitle("Total de Préstamos por Region") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Gráfico de barras por sector
grafico_sector <- ggplot(descriptivas_sector, aes(x = Sect, y = Total_Prestamos)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Sector", y = "Total de Préstamos", title = "Distribución de Préstamos totales por Sector") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

# Mostrar los gráficos
grafico_departamento
grafico_sector
```
Del 1er gráfico se puede afirmar que es el Callao que más monto de prestamos ha solicitado, pero eso no quiere decir que es la región que mayor cantidad de prestamos a solicitado.

Por otro lado, observamos que en el 2do gráfico que el sector Comercio es el que mas monto de préstamo solicito, ahora analizaremos si es el sector que mas cantidad de prestamos ha solicitado a la entidades bancarias.


##Analizando cual es el Departamento y Sector que mayor cantidad de veces solicito un préstamo.

###Para proceder con el siguiente objetivo, primero aclararemos 2 nuevas variables:

- NumParticipaciones: La cantidad de veces que participo una entidad bancaria en dar un préstamo por Departamento

- SumaPaticipaciones: La suma de todas la NumParticipaciones que hay por departamento


Procederemos a analizar el numero de participaciones que ha tenido cada entidad con respecto a la distribución geográfica donde otorgaron los prestamos, de mayor a menor participación por departamento y sector
```{r}
participaciones <- data %>%
  group_by(NomEnt, Depa) %>%
  count() %>%
  rename(NumParticipaciones = n) %>%
  arrange(desc(NumParticipaciones))
participaciones
```

```{r}
participaciones_Sect <- data %>%
  group_by(NomEnt, Sect) %>%
  count() %>%
  rename(NumParticipaciones = n) %>%
  arrange(desc(NumParticipaciones))
participaciones_Sect
```

Ahora hallamos la suma de sus participaciones por departamento y por sector
```{r}
participaciones_departamento <- participaciones %>%
  group_by(Depa) %>%
  summarise(SumaParticipaciones = sum(NumParticipaciones)) %>%
  arrange(desc(SumaParticipaciones))

participaciones_departamento
```
```{r}
participaciones_Sector <- participaciones_Sect %>%
  group_by(Sect) %>%
  summarise(SumaParticipaciones = sum(NumParticipaciones)) %>%
  arrange(desc(SumaParticipaciones))

participaciones_Sector
```
- Haciendo uso del gráfico de frecuencia
```{r}
ggplot(data, aes(x = Depa)) +
  geom_bar(fill = "lightblue") +
  labs(x = "Departamento", y = "Frecuencia") +
  ggtitle("Frecuencia de préstamos por Region") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data, aes(x = Sect)) +
  geom_bar(fill = "green") +
  labs(x = "Sector", y = "Frecuencia") +
  ggtitle("Frecuencia de cantidad préstamos por sector") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
- Se puede observar que Lima es la región que más se repite con 79 apariciones. Por lo que se concluye que Lima es la moda y es la región que mayor cantidad de prestamos solicito a las distintas entidades bancarias. 

- Tambien se concluye que el comercio es la moda con relación a la cantidad de prestamos solicitados debido a que aparece 631 veces.

Analizamos el total de participaciones que ha tenido cada entidad financiera
```{r}
suma_total <- participaciones %>%
  group_by(NomEnt) %>%
  summarise(SumaTotalParticipaciones = sum(NumParticipaciones)) %>%
  arrange(desc(SumaTotalParticipaciones))

suma_total
```
```{r}
summary(suma_total$SumaTotalParticipaciones)
```
- Diagrama de Caja
```{r}
boxplot(suma_total$SumaTotalParticipaciones, horizontal = TRUE, col = "green",
        main = "Total de Participaciones por entidad")
```
- Se observa que en la cantidad de participaciones por entidad hay presente 2 datos atípicos que serian 908 como el más alejado a la derecha y 257, ambos pertenecientes al BCP y BANCO BBVA PERU

- Haciendo un análisis entre la gráfica y el el total de participaciones que ha tenido cada entidad, se pude concluir que el CMAC DE HUANCAYO y CRAC RAIZ son las entidades financieras que menos han participado con respecto a otorgar prestamos a las empresas, solo han otorgado un solo préstamo.

- Mientras que vemos que el BCP es la entidad bancaria que más veces otorgo un préstamo a las empresas, por lo tanto el BCP es la moda.


Y si se quiere observar a la distribución global de la entidades financieras en los departamento, realizaremos lo siguiente:
```{r}
distribucion <- data %>%
  group_by(Depa, NomEnt) %>%
  summarise(Count = n()) %>%
  ungroup()
distribucion 

ggplot(distribucion, aes(x = Depa, y = Count, fill = NomEnt)) +
  geom_bar(color = "black", stat = "identity") +
  scale_fill_viridis_d() +
  labs(title = "Gráfico apilado de la distribución de Entidades Financieras",
       x = "Departamento",
       y = "Cantidad") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
De la tabla y del gráfico se puede concluir que:
- Lima es el departamento donde participaron más entidades bancarias distintas con 79, donde se destacan el BCP con 40 participaciones en Lima y el BANCO BBVA PERU con 21 participaciones.

- Se puede observar que el departamento del Apurimac es el departamento donde menos entidades entidades distintas han participado con 39, donde se destaca al banco BCP con 23 participaciones.

- Se observa que el departamento de Arequipa, es el departamento donde más veces ha recibido un préstamo por parte del BCP con 47 y la región de Loreto, es donde el BANCO BBVA PERU le otorgo más prestamos con 23.


Ahora analizaremos a los bancos del BCP y del BBVA, debido a que son las que más destacan por encima del resto, por lo que extraemos al departamento en el que otorgaron más prestamos:
```{r}
totalidad <- participaciones %>%
  filter(NomEnt == "BCP") %>%
  group_by(Depa) %>%
  summarise(SumaTotalParticipaciones = sum(NumParticipaciones)) %>%
  arrange(desc(SumaTotalParticipaciones))

dep_con_mas_participaciones_BCP <- totalidad$Depa[1:2]  # Obtenemos el departamento con la suma total más alta

totales <- participaciones %>%
  filter(NomEnt == "BANCO BBVA PERU") %>%
  group_by(Depa) %>%
  summarise(SumaTotalParticipaciones = sum(NumParticipaciones)) %>%
  arrange(desc(SumaTotalParticipaciones))

dep_con_mas_participaciones_BBVA <- totales$Depa[1]


dep_con_mas_participaciones_BCP
dep_con_mas_participaciones_BBVA
```
En las regiones de Arequipa y Moquegua son las 2 regiones que el BCP otorgo más prestamos

Y la región de Loreto es donde se el BBVA otorgo más prestamos.

##Analizando su distribución geográfica:
```{r}
distribucion_bcp <- participaciones %>%
  filter(NomEnt == "BCP") %>%
  group_by(Depa) %>%
  summarise(Count = sum(NumParticipaciones)) %>%
  ungroup()

porcentajes_bcp <- distribucion_bcp$Count / sum(distribucion_bcp$Count) * 100


tabla_porcentajes_BCP <- data.frame(Departamento = distribucion_bcp$Depa, Porcentaje = porcentajes_bcp)

tabla_porcentajes_BCP

#Sacamos su promedio
mean(tabla_porcentajes_BCP$Porcentaje)

barplot(tabla_porcentajes_BCP$Porcentaje, 
        names.arg = tabla_porcentajes_BCP$Departamento, 
        col = gray.colors(nrow(tabla_porcentajes_BCP)),
        las = 2,
        cex.names = 0.6)
```
- Se deduce mediante la tabla y la gráfica que la distribución de los prestamos por parte del BCP esta más equilibrada debido a que se supera por poco el promedio que es de 4%, donde las regiones de Arequipa y Moquegua son las que en más oportunidades han recibido prestamos por parte del BCP con un 5.17% cada una.

```{r}
#Analizando al BBVA
distribucion_bbva <- participaciones %>%
  filter(NomEnt == "BANCO BBVA PERU") %>%
  group_by(Depa) %>%
  summarise(Count = sum(NumParticipaciones)) %>%
  ungroup()

porcentajes_bbva <- distribucion_bbva$Count / sum(distribucion_bbva$Count) * 100

tabla_porcentajes <- data.frame(Departamento = distribucion_bbva$Depa, Porcentaje = porcentajes_bbva)

tabla_porcentajes

#Sacamos su promedio
mean(tabla_porcentajes$Porcentaje)

barplot(tabla_porcentajes$Porcentaje, 
        names.arg = tabla_porcentajes$Departamento, 
        col = gray.colors(nrow(tabla_porcentajes)),
        las = 2,
        cex.names = 0.6,
        xlim = c(0, nrow(tabla_porcentajes) + 1))

```
- Aquí se observa que la distribución de Prestamos, por parte del BBVA, hay más disparidad, donde se esta favoreciendo a los departamentos de Loreto, Pasco y Lima, los 3 llegando a un porcentaje mínimo de 8.17%, muy por encima del promedio que es de 4%.


Ahora calcularemos la deuda que mantiene cada empresa tras los prestamos realizados. 
```{r}
data <- data %>%
  mutate(Deuda = MonPre - MonCo)
data
```

```{r}
# Deuda total
deuda_empresa_depa_sect <- data %>%
  group_by(NomEmp, Depa, Sect) %>%
  summarise(DeudaTotal = sum(Deuda)) %>%
  arrange(desc(DeudaTotal))

deuda_empresa_depa_sect
```

Ahora filtramos a la empresas que deben millones a los bancos a nivel departamental y sectorial
```{r}
deuda_empresa <- data %>%
  group_by(NomEmp, Depa, Sect) %>%
  summarise(DeudaTotal = sum(Deuda)) %>%
  filter(DeudaTotal >= 1000000) %>%
  arrange(desc(DeudaTotal))

deuda_empresa
```
###Observamos las deudas de las empresas
```{r}
ggplot(deuda_empresa, aes(x = reorder(NomEmp, -DeudaTotal), y = DeudaTotal)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Empresa", y = "", title = "Deuda Total") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 47, hjust = 1))
```
```{r}
summary(deuda_empresa$DeudaTotal)
```
- Gráfico de puntos
```{r}
Deuda<-deuda_empresa$DeudaTotal
plot(Deuda)
```
- De este gráfico concluimos que las deudas de las empresas poseen una mediana y valor máximo de S/ 2000000, por lo que el 50% de las empresas deben esa cantidad. 15 empresas son las que deben  S/2000000
- Mientras que la deuda mínima de una empresa es de S/1183600 perteneciente a CONSTRUCCIONES ELECTROMECANICAS DELCROSA


Ahora analizaremos las que han pagado sus deudas o que están próximos a pagar en un rango menor a 1000 soles
```{r}
deudas_menores <- data %>%
  filter(Deuda < 1000) %>%
  select(NomEmp, Depa, Deuda) %>%
  arrange(desc(Deuda)) %>%
  slice(1:(n() - 1))

deudas_menores
```

```{r}
boxplot(deudas_menores$Deuda, horizontal = TRUE, col = "green",
        xlab = "Deuda", ylab = "", main = "Boxplot de Deuda")

summary(deudas_menores$Deuda)
```
- Podemos observar que hay una empresa que si ha pagado su deuda, casi en su totalidad, y es TRANSPORTES TRANSCISCAR S.A.C. que logro disminuir su deuda a S/0.158.	

- Se puede apreciar que el 50% de las empresas tienen una deuda menor o igual a S/340.64 y que la otra mitad tiene es mayor o igual que S/340.64 

- Se observa que 6 empresas son las que poseen una deuda igual a S/600, y que 28 empresas mantienen un deuda menor a S/100.

- Ahora evaluaremos el impacto de los prestamos en las tasas de empleo y desempleo mediante el análisis de las variables a nivel anual y a nivel departamental

```{r}
#Totalidad de la tasa de empleo de los años 2018, 2019, 2020, 2021
Totalidad_empleo<-data.frame(
  Anio=c(2018,2019,2020,2021),
  Tasa=c(sum(datosT$`Tasa de Empleo 2018`),
                   sum(datosT$`Tasa de Empleo 2019`),
                   sum(datosT$`Tasa de Empleo 2020`),
                   sum(datosT$`Tasa de Empleo 2021`))
)
#Totalidad de la tasa de desempleo de los años 2018, 2019, 2020, 2021
total_desempleo<-data.frame(
  Anio=c(2018, 2019, 2020, 2021),
  Tasa=c(sum(datosT$`Tasa de Desempleo 2018`),
                   sum(datosT$`Tasa de Desempleo 2019`),
                   sum(datosT$`Tasa de Desempleo 2020`),
                   sum(datosT$`Tasa de Desempleo 2021`))
)

Totalidad_empleo
total_desempleo
```

```{r}
# Tasa de Empleo
ggplot(Totalidad_empleo) +
 aes(x = Anio, y = Tasa) +
 geom_line(colour = "#112446") +
 labs(x = "Año", 
 y = "Tasa de Empleo Total", title = "Tasa de Empleo Anual Total") +
 theme_minimal()

# Tasa de Desempleo
ggplot(total_desempleo) +
 aes(x = Anio, y = Tasa) +
 geom_line(colour = "darkred") +
 labs(x = "Año", 
 y = "Tasa de Desmpleo Total", title = "Tasa de Desempleo Anual Total") +
 theme_minimal()
```
Comparando las tasas de empleo y de desempleo anuales mediante un gráfico de barras
```{r}
# Crear vectores con las medias de las tasas de empleo y desempleo
medias_empleo <- c(sum(datosT$`Tasa de Empleo 2018`),
                   sum(datosT$`Tasa de Empleo 2019`),
                   sum(datosT$`Tasa de Empleo 2020`),
                   sum(datosT$`Tasa de Empleo 2021`))

medias_desempleo <- c(sum(datosT$`Tasa de Desempleo 2018`),
                      sum(datosT$`Tasa de Desempleo 2019`),
                      sum(datosT$`Tasa de Desempleo 2020`),
                      sum(datosT$`Tasa de Desempleo 2021`))

# Crear un vector con los años
anios <- c(2018, 2019, 2020, 2021)

# Crear el gráfico comparativo de barras
barplot(rbind(medias_empleo, medias_desempleo),
        beside = TRUE,
        names.arg = anios,
        legend.text = c("Empleo", "Desempleo"),
        xlab = "Año", ylab = "Suma total de Tasa",
        main = "Comparación de Tasas de Empleo y Desempleo por Año"
        ,col = c("steelblue", "darkred"))
```
- El gráfico representa la comparación de las tasas medias de empleo y desempleo a lo largo de los años.

- Entonces podemos concluir que la tasa de desempleo en general ha aumentado en el año 2020, probablemente debido a la coyuntura de la pandemia.

Ahora obtenemos las tasas de empleo y desempleo totales, 2018 al 2021, por departamento:
```{r}
total_empleo_departamento <- datosT %>%
  group_by(Depatamento) %>%
  summarise(
    Total_Tasa_Empleo= sum(`Tasa de Empleo 2018`,`Tasa de Empleo 2019`,`Tasa de Empleo 2020`,`Tasa de Empleo 2021`))
total_empleo_departamento
```
```{r}
#tasas de desempleo totales por departamento:
total_desempleo_departamento <- datosT %>%
  group_by(Depatamento) %>%
  summarise(
    Total_Tasa_Desempleo= sum(`Tasa de Desempleo 2018`,`Tasa de Desempleo 2019`,`Tasa de Desempleo 2020`,`Tasa de Desempleo 2021`))
total_desempleo_departamento
```
```{r}
datos_combinados <- merge(total_empleo_departamento, total_desempleo_departamento, by = "Depatamento")

datos_grafico <- data.frame(
  Departamento = datos_combinados$Depatamento,
  Tasa_Empleo = datos_combinados$Total_Tasa_Empleo,
  Tasa_Desempleo = datos_combinados$Total_Tasa_Desempleo)

ggplot(datos_grafico, aes(x = Departamento)) +
  geom_bar(aes(y = Tasa_Empleo, fill = "Tasa de Empleo"), stat = "identity") +
  geom_bar(aes(y = Tasa_Desempleo, fill = "Tasa de Desempleo"), stat = "identity") +
  labs(x = "Departamento", y = "Totalidad de Tasa") +
  scale_fill_manual(values = c("Tasa de Empleo" = "lightblue", "Tasa de Desempleo" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
- De esta gráfica podemos analizar que la tasa de desempleo ha ido en aumento conforme la pandemia apareció, se puede observar que la tasa de desempleo llega a superar a más de la mitad de la tasa de empleo de varias regiones, entre ellas Arequipa y la provincia constitucional del Callo.

- Pero en otras se puede observar que la tasa de desempleo es muy poca como vemos en la región de Madre Dios que posee una tasa total de desempleo de  10.94% mientras que posee una tasa total de empleo del 390.56% de los últimos 4 años.


**Ultimo objetivo: ** 
Debemos identificar los posibles sesgos en las muestras seleccionadas, evaluando la validez y confiabilidad de los resultados obtenidos mediante análisis estadístico, con el fin de garantizar la robustez del análisis y asegurar la calidad de los hallazgos a nivel departamental y sectorial.

- En relación a la calidad de los datos:
```{r}
Na = sum((is.na(data)))
Na
Na2 = sum((is.na(datosT)))
Na2
```
- Se puede observar que los datos con los que trabajamos están limpios, por lo tanto no hay ningún dato faltante 

- Sesgo de selección: 
Al elegir solo las empresas con los mayores montos de préstamos, es probable que exista un sesgo de selección. Sin embargo, como se menciono al principio, se siguió un enfoque estratificado, que se basa en dividir la población en subgrupos homogéneos o estratos antes de realizar el muestreo, y posteriormente se realizo una estratificación empleando a los percentiles en búsqueda de una menor inclinación en la representación de la muestra. Por lo que se concluye que la muestra si es representativa.

- Otro sesgo que puede haber seria que solo tomamos a la empresas activas en el presente debido a que nuestro trabajo necesita a las empresas que han recibido el monto de Reactiva 2020 que sigan en funcionamiento por lo que usar a las inactivas no favorecerían a nuestro trabajo debido a que han quebrado.
